<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Queue Agent Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --accent:#2563eb; --bg-primary:#f1f5f9; --bg-card:#fff; --text-primary:#0f172a; --text-secondary:#64748b; --border:#e2e8f0;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;width:100%;background:var(--bg-primary);color:var(--text-primary);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif}
    .dashboard{min-height:100vh;width:100vw;padding:20px;display:flex;flex-direction:column;gap:16px}
    .header{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:16px}
    .title{
      display:flex;flex-direction:column;gap:6px
    }
    h1{font-size:2.25rem;font-weight:800}
    .subtitle{color:var(--text-secondary)}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .card{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.06)}
    .dropzone{display:flex;align-items:center;justify-content:center;gap:10px;border:2px dashed var(--border);padding:18px;border-radius:14px;cursor:pointer;background:#fff}
    .dropzone.drag{border-color:var(--accent);background:#eff6ff}
    .pill{padding:6px 12px;border-radius:999px;border:1px solid var(--border);background:#fff}
    .btn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:#1d4ed8;color:#fff}
    .btn.ghost{background:transparent}
    .input{border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:#fff}
    .grid{display:grid;gap:16px}
    .grid.kpis{grid-template-columns:repeat(4,1fr)}
    .kpi{display:flex;align-items:center;justify-content:space-between}
    .kpi h2{font-size:.8rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.04em}
    .kpi .val{font-size:2rem;font-weight:800}
    .charts{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
    .chart-card{height:320px;min-height:0;position:relative;display:flex;flex-direction:column}
    .chart-card canvas{height:100% !important;width:100% !important}
    .chart-title{font-weight:700;margin-bottom:6px}
    .table-card{padding:0;overflow:hidden}
    table{width:100%;border-collapse:collapse}
    th,td{padding:14px 16px;border-bottom:1px solid var(--border);text-align:left}
    th{position:sticky;top:0;background:#f8fafc;font-weight:700;color:var(--text-secondary);text-transform:uppercase;font-size:.8rem;z-index:5}
    tr:hover td{background:#f8fafc}
    .muted{color:var(--text-secondary)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grow{flex:1}
    .hidden{display:none !important}
    @media(max-width:1100px){.charts{grid-template-columns:1fr}.grid.kpis{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.grid.kpis{grid-template-columns:1fr} h1{font-size:1.6rem}}
  </style>
</head>
<body>
  <div class="dashboard">
    <header class="header">
      <div class="title">
        <h1 id="title">Queue Agent Dashboard</h1>
        <!--<div class="subtitle" id="subtitle">Drop CSVs, pick a date range, and go.</div>-->
      </div>
      <div class="controls">
        <div class="card row">
          <label class="pill">From <input class="input" type="date" id="fromDate"></label>
          <label class="pill">To <input class="input" type="date" id="toDate"></label>
          <button class="btn" data-q="today">Today</button>
          <button class="btn" data-q="yesterday">Yesterday</button>
          <button class="btn" data-q="last7">Last 7</button>
          <button class="btn primary" id="buildBtn">Build dashboard</button>
        </div>
        <div class="card row">
          <div id="dropzone" class="dropzone">
            <span>⬆️ Drag & drop CSVs here (or click)</span>
            <input id="fileInput" type="file" accept=".csv" multiple class="hidden" />
          </div>
          <button class="btn" id="clearStorage">Clear data</button>
          <button class="btn" id="exportData">Export data</button>
          <input id="importData" type="file" accept="application/json" class="hidden" />
          <button class="btn" id="importBtn">Import</button>
        </div>
      </div>
    </header>

    <main class="grid" style="grid-template-rows:auto auto 1fr;">
      <!-- KPIs -->
      <section class="grid kpis">
        <div class="card kpi"><div><h2>Total Calls</h2><div class="val" id="kpi-total">-</div></div><span class="pill">Calls</span></div>
        <div class="card kpi"><div><h2>Avg Answered / Hour</h2><div class="val" id="kpi-aph">-</div></div><span class="pill">Rate</span></div>
        <div class="card kpi"><div><h2>Avg Ring Time</h2><div class="val" id="kpi-ring">-</div></div><span class="pill">Time</span></div>
        <div class="card kpi"><div><h2>Avg Talk Time</h2><div class="val" id="kpi-talk">-</div></div><span class="pill">Time</span></div>
      </section>

      <!-- Charts -->
      <section class="charts">
        <div class="card chart-card"><div class="chart-title">Calls per Agent</div><canvas id="chartCalls"></canvas></div>
        <div class="card chart-card"><div class="chart-title">Average Talk Time by Agent</div><canvas id="chartTalk"></canvas></div>
        <div class="card chart-card"><div class="chart-title">Average Ring Time by Agent</div><canvas id="chartRing"></canvas></div>
        <div class="card chart-card"><div class="chart-title">Answered per Hour by Agent</div><canvas id="chartAph"></canvas></div>
      </section>

      <!-- Table -->
      <section class="card table-card">
        <div class="row" style="padding:12px 16px;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)">
          <div style="font-weight:700;font-size:1.1rem">Agent Performance Summary</div>
          <div class="muted" id="metaSummary">—</div>
        </div>
        <div style="max-height:420px;overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Agent</th>
                <th>Calls</th>
                <th>Logged In</th>
                <th>Answered / Hour</th>
                <th>Mean Ring</th>
                <th>Mean Talk</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
  // ----------------- Utilities -----------------
  const KEY = 'ivr_data_v2';
  const CACHE_KEY = 'ivr_dash_cache_v2';
  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));

  const hmsToSeconds = (x)=>{ if(x==null) return 0; const s=String(x).trim(); if(!s||s==='0') return 0; const parts=s.split(':').map(Number); if(parts.length===3){return parts[0]*3600+parts[1]*60+parts[2]} if(parts.length===2){return parts[0]*60+parts[1]} const f=parseFloat(s); return isNaN(f)?0:Math.round(f) };
  const secondsToHMS = (secs)=>{ secs=Math.round(secs||0); const h=Math.floor(secs/3600), m=Math.floor((secs%3600)/60), s=secs%60; return `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}` };
  const pctToFloat = (x)=>{ if(x==null) return null; const s=String(x).trim().replace('%',''); const n=parseFloat(s); return isNaN(n)?null:n };
  const fmtNum = (n)=> (typeof n==='number'? n.toLocaleString(): '-')
  const fmt1 = (n)=> (typeof n==='number'? n.toFixed(1): '-')

  function findHeaderRow(rows){
    // Look for a row whose first cell is exactly "Agent"
    for(let i=0;i<rows.length;i++){
      if(String(rows[i][0]).trim()==='Agent') return i;
    }
    return 4; // fallback similar to the Python script
  }

  function parseCSVContent(content, filename){
    const parsed = Papa.parse(content, {delimiter: ',', skipEmptyLines: 'greedy'});
    const rows = parsed.data;
    const headerRowIndex = findHeaderRow(rows);
    const header = rows[headerRowIndex];
    const body = rows.slice(headerRowIndex+1);
    // Map headers to standard names like the python version
    const rename = {
      'Unnamed: 1': 'Agent Extra',
      'Unnamed: 3': 'Queue Extra',
      'Calls': 'Calls Answered',
      'Unnamed: 6': '% Calls Serviced',
      'Unnamed: 7': 'Answered per Hour',
      'Unnamed: 9': 'Mean Ring Time',
      'Unnamed: 11': 'Mean Talk Time',
    };
    const idx = {};
    header.forEach((h,i)=>{
      const name = rename[h] || h;
      idx[name]=i;
    });
    // Normalize rows into objects
    const out=[];
    for(const r of body){
      const agent = (r[idx['Agent']]||'').toString();
      if(!agent || agent==='Agent' || agent==='Total:') continue;
      const rec = {
        Agent: agent,
        Queue: idx['Queue']!=null ? r[idx['Queue']] : undefined,
        'Total Logged in Time': r[idx['Total Logged in Time']],
        'Calls Answered': Number(r[idx['Calls Answered']]||0) || 0,
        '% Calls Serviced': r[idx['% Calls Serviced']],
        'Answered per Hour': r[idx['Answered per Hour']],
        'Ring Time': r[idx['Ring Time']],
        'Mean Ring Time': r[idx['Mean Ring Time']],
        'Talk Time': r[idx['Talk Time']],
        'Mean Talk Time': r[idx['Mean Talk Time']],
      };
      // derived seconds
      ['Total Logged in Time','Ring Time','Mean Ring Time','Talk Time','Mean Talk Time'].forEach(k=>{
        if(rec[k]!=null) rec[k+' (s)'] = hmsToSeconds(rec[k]);
      })
      if(rec['% Calls Serviced']!=null) rec['% Calls Serviced (num)'] = pctToFloat(rec['% Calls Serviced']);
      if(rec['Answered per Hour']!=null){ const n=parseFloat(rec['Answered per Hour']); rec['Answered per Hour (num)'] = isNaN(n)? null: n; }
      out.push(rec);
    }
    // Try to infer date from filename (YYYY-MM-DD, DDMM, or Jul 7 2025 etc.)
    let date=null;
    const f = filename||'';
    
    // First try YYYY-MM-DD format
    const ymd = f.match(/(20\d{2})[-_](\d{1,2})[-_](\d{1,2})/);
    if(ymd){ date = new Date(Number(ymd[1]), Number(ymd[2])-1, Number(ymd[3])); }
    
    // Then try _DDMM_ format (like _1308_ for August 13)
    if(!date){
      const ddmm = f.match(/_(\d{2})(\d{2})_/);
      if(ddmm){
        const day = Number(ddmm[1]);
        const month = Number(ddmm[2]);
        const year = new Date().getFullYear();
        // Validate day and month ranges
        if(day >= 1 && day <= 31 && month >= 1 && month <= 12){
          date = new Date(year, month-1, day);
        }
      }
    }
    
    // Finally try month name format
    if(!date){
      const monMap = {jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};
      const m = f.toLowerCase().match(/(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[a-z]*[_\- ]?(\d{1,2})[, _\- ]?(20\d{2})?/);
      if(m){ date = new Date(Number(m[3]||new Date().getFullYear()), monMap[m[1]], Number(m[2])); }
    }
    return { rows: out, dateHint: date? date.toISOString().slice(0,10): null };
  }

  function storeFiles(files){
    const db = JSON.parse(localStorage.getItem(KEY) || '{"files":[]}');
    if(!db.files) db.files=[];
    localStorage.setItem(KEY, JSON.stringify(db));

    const promises = Array.from(files).map(file=> new Promise((res)=>{
      const reader = new FileReader();
      reader.onload = ()=>{
        const {rows, dateHint} = parseCSVContent(reader.result, file.name);
        const hash = simpleHash(reader.result + file.name + file.size);
        const entry = { id: hash, name: file.name, size: file.size, addedAt: Date.now(), date: dateHint, rows };
        db.files = db.files.filter(f=>f.id!==hash); // replace if same hash
        db.files.push(entry);
        localStorage.setItem(KEY, JSON.stringify(db));
        res(entry);
      };
      reader.readAsText(file);
    }));
    return Promise.all(promises);
  }

  function listFiles(){
    const db = JSON.parse(localStorage.getItem(KEY) || '{"files":[]}');
    return db.files||[];
  }

  function updateFileDate(id, isoDate){
    const db = JSON.parse(localStorage.getItem(KEY) || '{"files":[]}');
    const f = (db.files||[]).find(x=>x.id===id); if(f){ f.date = isoDate; localStorage.setItem(KEY, JSON.stringify(db)); }
  }

  function getRange(){
    const a = $('#fromDate').value, b=$('#toDate').value; if(!a||!b) return null; return {from:a, to:b};
  }

  function filesInRange(range){
    const files=listFiles();
    return files.filter(f=>{ if(!f.date) return false; return f.date>=range.from && f.date<=range.to; });
  }

  function build(range){
    const cacheKey = cacheKeyFor(range);
    const cache = JSON.parse(localStorage.getItem(CACHE_KEY)||'{}');
    if(cache[cacheKey]){ return cache[cacheKey]; }

    const fs = filesInRange(range);
    const allRows = fs.flatMap(f=>f.rows);

    // aggregate by Agent
    const byAgent = new Map();
    for(const r of allRows){
      const key = r.Agent||'Unknown';
      const acc = byAgent.get(key) || {Agent:key, Calls:0, Logged:0, Ring:0, Talk:0};
      acc.Calls += Number(r['Calls Answered']||0);
      acc.Logged += Number(r['Total Logged in Time (s)']||0);
      acc.Ring += Number(r['Ring Time (s)']||0);
      acc.Talk += Number(r['Talk Time (s)']||0);
      byAgent.set(key, acc);
    }

    const table = Array.from(byAgent.values()).map(x=>{
      const ansPerHour = x.Logged>0 ? (x.Calls / (x.Logged/3600)) : 0;
      const meanRing = x.Calls>0 ? x.Ring/x.Calls : 0;
      const meanTalk = x.Calls>0 ? x.Talk/x.Calls : 0;
      return {
        agent:x.Agent,
        calls:x.Calls,
        logged_in: secondsToHMS(x.Logged),
        ans_per_hour: ansPerHour,
        mean_ring: secondsToHMS(meanRing),
        mean_talk: secondsToHMS(meanTalk)
      }
    }).sort((a,b)=> b.calls - a.calls);

    const totalCalls = table.reduce((s,r)=>s+r.calls,0);
    const avgAph = table.length ? table.reduce((s,r)=>s+r.ans_per_hour,0)/table.length : 0;
    const avgRing = table.length ? table.reduce((s,r)=>s + hmsToSeconds(r.mean_ring),0)/table.length : 0; // seconds
    const avgTalk = table.length ? table.reduce((s,r)=>s + hmsToSeconds(r.mean_talk),0)/table.length : 0; // seconds

    const data = {
      agents: table.map(r=>r.agent),
      calls_per_agent: table.map(r=>r.calls),
      mean_talk_time: table.map(r=> hmsToSeconds(r.mean_talk) ),
      mean_ring_time: table.map(r=> hmsToSeconds(r.mean_ring) ),
      answered_per_hour: table.map(r=> r.ans_per_hour ),
      table,
      kpis: {
        total_calls: totalCalls,
        avg_answered_per_hour: Number(avgAph.toFixed(2)),
        avg_ring: secondsToHMS(avgRing),
        avg_talk: secondsToHMS(avgTalk)
      },
      meta: {
        files: fs.map(f=>({name:f.name,date:f.date,rows:f.rows.length})),
      }
    };

    cache[cacheKey]=data; localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
    return data;
  }

  function cacheKeyFor(range){
    const fs = filesInRange(range);
    const sig = fs.map(f=> f.id+':'+(f.date||'')).sort().join('|');
    return `${range.from}_${range.to}__${simpleHash(sig)}`;
  }

  function simpleHash(str){
    let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h, 16777619) } return (h>>>0).toString(36);
  }

  // Chart.js performance defaults
  if (window.Chart) {
    Chart.defaults.animation = false;
    Chart.defaults.responsiveAnimationDuration = 0;
    Chart.defaults.maintainAspectRatio = true;
    Chart.defaults.aspectRatio = 2;
    Chart.defaults.plugins.legend.display = false;
    Chart.defaults.elements.bar.borderSkipped = false;
    Chart.defaults.elements.bar.borderRadius = 4;
  }

  // ----------------- UI wiring -----------------
  let charts = [];
  function clearCharts(){ charts.forEach(c=>c.destroy()); charts=[]; }
  function makeBarChart(id, labels, values, label, color){
    const ctx = document.getElementById(id).getContext('2d');
    const c = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label,
          data: values,
          backgroundColor: color + '20',
          borderColor: color,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 2,            // width / height (used when container allows)
        animation: false,          // big perf win
        interaction: { mode: 'nearest', intersect: false, axis: 'x' },
        plugins: { legend: { display: false }, decimation: { enabled: false } },
        scales: {
          x: { grid: { display: false } },
          y: { beginAtZero: true, ticks: { precision: 0 } }
        }
      }
    });
    charts.push(c);
    return c;
  }

  function render(range){
    const data = build(range);
    // KPIs
    $('#kpi-total').textContent = fmtNum(data.kpis.total_calls);
    $('#kpi-aph').textContent = fmt1(data.kpis.avg_answered_per_hour);
    $('#kpi-ring').textContent = data.kpis.avg_ring;
    $('#kpi-talk').textContent = data.kpis.avg_talk;

    // Title & meta
    const nice = (iso)=> new Date(iso+'T00:00:00').toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
    const rangeText = range.from===range.to ? nice(range.from) : `${nice(range.from)} – ${nice(range.to)}`;
    $('#title').textContent = `Queue Agent Dashboard — ${rangeText}`;
    $('#metaSummary').textContent = `${data.meta.files.length} file(s) • ${data.kpis.total_calls} calls`;

    // Table
    const tbody = $('#tbody'); tbody.innerHTML = '';
    data.table.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.agent}</td><td>${fmtNum(r.calls)}</td><td>${r.logged_in}</td><td>${fmt1(r.ans_per_hour)}</td><td>${r.mean_ring}</td><td>${r.mean_talk}</td>`;
      tbody.appendChild(tr);
    });

    // Charts
    clearCharts();
    const truncate=(s)=> s.length>18? s.slice(0,18)+'…': s;
    const labels = data.agents.map(truncate);
    makeBarChart('chartCalls', labels, data.calls_per_agent, 'Calls', '#2563eb');
    makeBarChart('chartTalk', labels, data.mean_talk_time, 'Talk Time (s)', '#059669');
    makeBarChart('chartRing', labels, data.mean_ring_time, 'Ring Time (s)', '#dc2626');
    makeBarChart('chartAph', labels, data.answered_per_hour, 'Answered/Hour', '#7c3aed');
  }

  function ensureRangeDefaults(){
    const files=listFiles();
    if(files.length){
      const dates = files.filter(f=>!!f.date).map(f=>f.date).sort();
      if(dates.length){
        $('#fromDate').value = dates[0];
        $('#toDate').value = dates[dates.length-1];
      }
    }
  }

  // Dropzone
  const dz = $('#dropzone');
  dz.addEventListener('click', ()=> $('#fileInput').click());
  dz.addEventListener('dragover', e=>{e.preventDefault(); dz.classList.add('drag');});
  dz.addEventListener('dragleave', ()=> dz.classList.remove('drag'));
  dz.addEventListener('drop', async (e)=>{
    e.preventDefault(); dz.classList.remove('drag');
    const files = e.dataTransfer.files; await storeFiles(files); await promptDatesIfMissing(); ensureRangeDefaults();
  });
  $('#fileInput').addEventListener('change', async (e)=>{ await storeFiles(e.target.files); await promptDatesIfMissing(); ensureRangeDefaults(); e.target.value=''; });

  async function promptDatesIfMissing(){
    const files=listFiles();
    for(const f of files){ if(!f.date){ const iso = await quickDatePrompt(f.name); updateFileDate(f.id, iso); } }
  }

  function quickDatePrompt(filename){
    return new Promise((res)=>{
      const overlay = document.createElement('div');
      overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:9999';
      overlay.innerHTML = `
        <div class="card" style="min-width:320px;max-width:94vw">
          <div style="font-weight:800;margin-bottom:6px">Set date for: ${filename}</div>
          <div class="muted" style="margin-bottom:10px">We couldn't infer a date from the filename. Choose the service date for this CSV.</div>
          <input type="date" class="input" id="_datePick" />
          <div class="row" style="margin-top:12px;justify-content:flex-end">
            <button class="btn ghost" id="_cancel">Cancel</button>
            <button class="btn primary" id="_ok" disabled>Save</button>
          </div>
        </div>`;
      document.body.appendChild(overlay);
      const inp = overlay.querySelector('#_datePick');
      const ok = overlay.querySelector('#_ok');
      const cancel = overlay.querySelector('#_cancel');
      inp.addEventListener('input', ()=> ok.disabled = !inp.value);
      ok.addEventListener('click', ()=>{ const v=inp.value; document.body.removeChild(overlay); res(v); });
      cancel.addEventListener('click', ()=>{ document.body.removeChild(overlay); res(new Date().toISOString().slice(0,10)); });
    });
  }

  // Quick range buttons
  $$("button[data-q]").forEach(b=> b.addEventListener('click', ()=>{
    const q=b.dataset.q; const today = new Date();
    const iso = (d)=> d.toISOString().slice(0,10);
    if(q==='today'){ const d=new Date(today.getFullYear(),today.getMonth(),today.getDate()); $('#fromDate').value=iso(d); $('#toDate').value=iso(d); }
    if(q==='yesterday'){ const d=new Date(today.getFullYear(),today.getMonth(),today.getDate()-1); $('#fromDate').value=iso(d); $('#toDate').value=iso(d); }
    if(q==='last7'){ const end=new Date(today.getFullYear(),today.getMonth(),today.getDate()); const start=new Date(end); start.setDate(start.getDate()-6); $('#fromDate').value=iso(start); $('#toDate').value=iso(end); }
  }));

  // Build btn
  $('#buildBtn').addEventListener('click', ()=>{
    const range=getRange(); if(!range){ alert('Choose a From and To date first.'); return; }
    const fs = filesInRange(range);
    if(!fs.length){ alert('No files in the selected range. Import CSVs or adjust dates.'); return; }
    render(range);
  });

  // Clear / Export / Import
  $('#clearStorage').addEventListener('click', ()=>{
    if(confirm('Remove all imported data and cached dashboards?')){ localStorage.removeItem(KEY); localStorage.removeItem(CACHE_KEY); location.reload(); }
  });
  $('#exportData').addEventListener('click', ()=>{
    const payload = { data: JSON.parse(localStorage.getItem(KEY)||'{}'), cache: JSON.parse(localStorage.getItem(CACHE_KEY)||'{}') };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'ivr_local_export.json'; a.click();
  });
  $('#importBtn').addEventListener('click', ()=> $('#importData').click());
  $('#importData').addEventListener('change', (e)=>{
    const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(r.result); if(obj.data) localStorage.setItem(KEY, JSON.stringify(obj.data)); if(obj.cache) localStorage.setItem(CACHE_KEY, JSON.stringify(obj.cache)); alert('Imported.'); ensureRangeDefaults(); }catch(err){ alert('Invalid JSON.'); } }; r.readAsText(f);
  });

  // Boot
  ensureRangeDefaults();
  </script>
</body>
</html>
